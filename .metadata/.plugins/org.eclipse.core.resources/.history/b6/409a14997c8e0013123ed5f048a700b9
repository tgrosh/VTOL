package com.singletongames.vtol;

import java.io.BufferedInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;

import javax.xml.parsers.ParserConfigurationException;
import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;

import org.andengine.entity.modifier.ScaleModifier;
import org.andengine.entity.primitive.Rectangle;
import org.andengine.entity.shape.RectangularShape;
import org.andengine.entity.sprite.Sprite;
import org.andengine.entity.text.AutoWrap;
import org.andengine.entity.text.Text;
import org.andengine.util.debug.Debug;
import org.andengine.util.modifier.ease.EaseBackIn;
import org.andengine.util.modifier.ease.EaseBackOut;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.xml.sax.XMLReader;

import com.singletongames.vtol.Objective.ObjectiveStatus;

import android.view.animation.ScaleAnimation;

public class ObjectiveManager {
	List<Objective> objectives = new ArrayList<Objective>();
	LanderScene scene;
	RectangularShape drawArea;
	private List<Sprite> bullets = new ArrayList<Sprite>();
	private List<Sprite> checks = new ArrayList<Sprite>();
	int chapterID;	
	int levelID;
	private Rectangle area;
	
	public ObjectiveManager(LanderScene scene, RectangularShape drawArea, int chapterID, int levelID) {
		super();
		this.scene = scene;
		this.drawArea = drawArea;
		this.chapterID = chapterID;
		this.levelID = levelID;
		
		area = new Rectangle(drawArea.getX(), drawArea.getY(), drawArea.getWidth(), drawArea.getHeight(), Resources.mEngine.getVertexBufferObjectManager());
		
		Load();
	}

	private void Load() {
		loadObjectives();		
		drawObjectives();
	}

	private void loadObjectives() {
		try {
			final SAXParserFactory spf = SAXParserFactory.newInstance();
			
        	SAXParser sp = spf.newSAXParser();
			final XMLReader xmlReader = sp.getXMLReader();
			
			final ObjectiveParser objectiveParser = new ObjectiveParser(scene, chapterID, levelID, new IObjectiveListener() {
				@Override
				public void onComplete(Objective objective) {
					//if the objective had a prerequisite that isnt done, override the complete and set it back to in progress
					if (objective.prerequisiteID >=0 && getObjective(objective.prerequisiteID) != null && getObjective(objective.prerequisiteID).getStatus() != ObjectiveStatus.COMPLETE){
						objective.setStatus(ObjectiveStatus.INPROGRESS);
					}
					else{
						showCheckMark(getObjectivePosition(objective));	
					}
				}
				@Override
				public void onFail(Objective objective) {
				}
			});
	        xmlReader.setContentHandler(objectiveParser);
	        
			InputStream inputStream = Resources.mActivity.getAssets().open("objectives/Objectives.xml");			
            xmlReader.parse(new InputSource(new BufferedInputStream(inputStream)));
            
            this.objectives = objectiveParser.getObjectives();
            
            inputStream.close();            
		} 
        catch (IOException e) {
			e.printStackTrace();
		} 
        catch (SAXException e) {
			e.printStackTrace();
		} 
        catch (ParserConfigurationException e) {
			e.printStackTrace();
		}
	}

	private Objective getObjective(int objectiveID){
		for (Objective obj: objectives){
			if (obj.getObjectiveID() == objectiveID){
				return obj;
			}
		}
		return null;
	}
	
	protected void showCheckMark(int objectivePosition) {
		if (objectivePosition >= 0){
			Sprite check = new Sprite(-7, -5, Resources.ObjectiveCheck, Resources.mEngine.getVertexBufferObjectManager());
			checks.add(check);
			check.setScale(0);
			ScaleModifier scaler = new ScaleModifier(.5f, 0, 1, EaseBackOut.getInstance());
			check.registerEntityModifier(scaler);
			bullets.get(objectivePosition).attachChild(check);
		}
		
	}

	public List<Objective> getObjectives() {
		return objectives;
	}

	public void addObjective(Objective objective) {
		this.objectives.add(objective);
	}
	
	private void drawObjectives(){
		float currentY = drawArea.getY();
		
		for (int x=0; x< objectives.size(); x++){			
			Objective objective = objectives.get(x);
			
			Text txt = new Text(0, 0, Resources.mFont_Green24, objective.getDescription(), Resources.mEngine.getVertexBufferObjectManager());
			txt.setPosition(drawArea.getX() + 25, currentY);
			txt.setAutoWrap(AutoWrap.WORDS);
			txt.setAutoWrapWidth(drawArea.getWidth() - 25);
			
			Sprite bullet = new Sprite(drawArea.getX(), txt.getY() + txt.getHeight()/2 - Resources.ObjectiveBullet.getHeight()/2, Resources.ObjectiveBullet, Resources.mEngine.getVertexBufferObjectManager());
			bullets.add(bullet);
			
			scene.getHud().attachChild(txt);
			scene.getHud().attachChild(bullet);
			
			currentY += (txt.getHeight() + 5);
		}
	}
	
	private int getObjectivePosition(Objective objective){		
		for (int x=0; x< objectives.size(); x++){
			if (objectives.get(x).equals(objective)){
				return x;
			}
		}
		
		return -1;
	}
	
	public void show(){
		
	}
	
	public void hide(){
		
	}
}
